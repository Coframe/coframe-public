var Coframejs;(()=>{"use strict";var e={d:(n,t)=>{for(var r in t)e.o(t,r)&&!e.o(n,r)&&Object.defineProperty(n,r,{enumerable:!0,get:t[r]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};e.r(n),e.d(n,{getVariants:()=>getVariants,measureEngagement:()=>measureEngagement});var getRandomVariant=function(e){if(e&&0!==e.length)return e[Math.floor(Math.random()*e.length)]};function replaceHTMLContent(e,n,t){var r=!1;if(containsHTML(e)||containsHTML(n))setTimeout((function(){var o=document.createElement("div");o.innerHTML=e;var a=document.createElement("div");a.innerHTML=n;for(var i,c=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT,null);(i=c.nextNode())&&i.innerHTML.includes(e);)r=!0;i.parentElement&&function replaceNodeContent(e,n,t,r){for(var o=document.createDocumentFragment(),a=0,i=Array.from(e.childNodes);a<i.length;a++){var c=i[a];if(c.nodeType===Node.ELEMENT_NODE&&c instanceof Element&&c.outerHTML.includes(n.innerHTML)){c.setAttribute("coframe-id",r);var s=c.outerHTML.replace(n.innerHTML,t.innerHTML),u=document.createElement("div");u.innerHTML=s,u.firstChild&&o.appendChild(u.firstChild)}else o.appendChild(c)}e.textContent="",e.appendChild(o)}(i.parentElement,o,a,t)}),0);else for(var o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null),a=new RegExp(e,"g"),i=void 0;i=o.nextNode();)i.parentElement&&"script"!==i.parentElement.tagName.toLowerCase()&&i.textContent&&i.textContent.search(a)>=0&&(i.textContent=i.textContent.replace(a,n),i.parentElement.setAttribute("coframe-id",t),r=!0);return r}function containsHTML(e){return/<[a-z][\s\S]*>/i.test(e)}var t="coframe.user.token",getUUID=function(){return window.crypto&&crypto.randomUUID?crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}))},getCookie=function(e){var n=("; "+document.cookie).split("; ".concat(e,"="));return 2===n.length?n[1].split(";")[0]:""},setCookie=function(e,n){var t=new Date;t.setTime(t.getTime()+3456e7),document.cookie=e+"="+n+";path=/;expires="+t.toUTCString()},getCoframeUUID=function(){if(void 0!==getCookie(t))return getCookie(t);var e=getUUID();return setCookie(t,e),e},setCoframeCookie=function(){var e=getUUID();setCookie(t,e)},getXPath=function(e){for(var n="";e&&1==e.nodeType;e=e.parentNode)if(e.parentNode){var t=Array.prototype.indexOf.call(e.parentNode.childNodes,e)+1,r=t>1?"["+t.toString()+"]":"";n="/"+e.tagName.toLowerCase()+r+n}return n},getCssSelector=function(e){if(null===e)return"";for(var n=[];e&&e.nodeType===Node.ELEMENT_NODE;){var t=e.nodeName.toLowerCase();if(e.id){t+="#"+e.id,n.unshift(t);break}for(var r=e,o=1;r=r.previousElementSibling;)r.nodeName.toLowerCase()==t&&o++;1!=o&&(t+=":nth-of-type("+o+")"),n.unshift(t),e=e.parentNode}return n.join(" > ")},__awaiter=function(e,n,t,r){return new(t||(t=Promise))((function(o,a){function fulfilled(e){try{step(r.next(e))}catch(e){a(e)}}function rejected(e){try{step(r.throw(e))}catch(e){a(e)}}function step(e){e.done?o(e.value):function adopt(e){return e instanceof t?e:new t((function(n){n(e)}))}(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())}))},__generator=function(e,n){var t,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function verb(c){return function(s){return function step(c){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(t=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,r=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=n.call(e,i)}catch(e){c=[6,e],r=0}finally{t=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}};function sendEventToBackend(e,n){return void 0===n&&(n="events"),__awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t="https://ingest.coframe.com/ingest/v1/".concat(n,"/").concat(window.COFRAME_PAGE_ID,"/"),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})];case 2:return[2,r.sent().json()];case 3:return r.sent(),[3,4];case 4:return[2]}}))}))}function sendPageEngagementEvent(e,n,t){var r,o=t.isEngaged,a=t.sessionId,i=t.duration,c=void 0===i?0:i;return __awaiter(this,void 0,void 0,(function(){var t,i,s,u,d;return __generator(this,(function(l){return o||"click"!==e||(o=!0,sendSessionEvent(a,"session_start")),t=n.clientX+window.scrollX,i=n.clientY+window.scrollY,s=window.innerWidth,u=window.innerHeight,(d=null===(r=n.target)||void 0===r?void 0:r.closest("a, button, input, [onclick], [href]"))||(d=n.target),sendEventToBackend({type:e,coframe_page_id:window.COFRAME_PAGE_ID,session_id:a,content:{html:d.outerHTML,xpath:getXPath(d),selector:getCssSelector(d),position:{x:Math.round(t),y:Math.round(i)},screen_size:{width:s,height:u},"duration-ms":Math.round(c)}}),[2]}))}))}function fetchVariants(e,n,t,r){return __awaiter(this,void 0,void 0,(function(){var o,a,i,c,s,u,d,l;return __generator(this,(function(f){switch(f.label){case 0:return o="".concat("https://coframe-variants.s3.us-west-2.amazonaws.com/variants/v1","/").concat(e,".json"),[4,fetch(o)];case 1:return[4,f.sent().json()];case 2:for(a=f.sent().coframes,i=[],c=[],s=function(e){var n=null==t?void 0:t.find((function(n){return n.coframe_id===e.id})),r=e.variants.find((function(e){return e.id===(null==n?void 0:n.id)}));if(!r&&!(r=getRandomVariant(e.variants)))return"continue";i.push({variant_id:r.id,coframe_id:e.id}),c.push({id:r.id,original:e.original,copy:r.copy,coframe_id:e.id,copy_id:r.id,xpath:r.xpath,selector:r.selector})},u=0,d=a;u<d.length;u++)l=d[u],s(l);return n=i,null==r||r({variants:c,coframeIds:n}),[2,c]}}))}))}var session_awaiter=function(e,n,t,r){return new(t||(t=Promise))((function(o,a){function fulfilled(e){try{step(r.next(e))}catch(e){a(e)}}function rejected(e){try{step(r.throw(e))}catch(e){a(e)}}function step(e){e.done?o(e.value):function adopt(e){return e instanceof t?e:new t((function(n){n(e)}))}(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())}))},session_generator=function(e,n){var t,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function verb(c){return function(s){return function step(c){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(t=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,r=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=n.call(e,i)}catch(e){c=[6,e],r=0}finally{t=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}};function sendSessionEvent(e,n){sendEventToBackend({type:n,coframe_page_id:window.COFRAME_PAGE_ID,session_id:e})}const r=function useLocalStorage(e,n){var t=function(){try{var t=window.localStorage.getItem(e);return t?JSON.parse(t):n}catch(t){return console.warn("Error reading localStorage key “".concat(e,"”:"),t),n}}();return{value:t,setValue:function(n){try{var r=n instanceof Function?n(t):n;window.localStorage.setItem(e,JSON.stringify(r)),t=r}catch(n){console.warn("Error setting localStorage key “".concat(e,"”:"),n)}},removeValue:function(){try{window.localStorage.removeItem(e),t=n}catch(n){console.warn("Error removing localStorage key “".concat(e,"”:"),n)}}}};var o,src_awaiter=function(e,n,t,r){return new(t||(t=Promise))((function(o,a){function fulfilled(e){try{step(r.next(e))}catch(e){a(e)}}function rejected(e){try{step(r.throw(e))}catch(e){a(e)}}function step(e){e.done?o(e.value):function adopt(e){return e instanceof t?e:new t((function(n){n(e)}))}(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())}))},src_generator=function(e,n){var t,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function verb(c){return function(s){return function step(c){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(t=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,r=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=n.call(e,i)}catch(e){c=[6,e],r=0}finally{t=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}},a=1e4,i=!1,c=[],s=getUUID(),u=[];function getVariants(e){return src_awaiter(this,void 0,void 0,(function(){var n,t,o;return src_generator(this,(function(a){switch(a.label){case 0:return n=r("cf"),t=n.value,o=n.setValue,t?(c=t.coframeIds,fetchVariants(e,c,t.variants,o),[2,t.variants]):[4,fetchVariants(e,c,void 0,o)];case 1:return[2,a.sent()]}}))}))}function measureEngagement(){var e=(new Date).getTime()-(o?o.getTime():0);!i&&e>=a?(i=!0,sendSessionEvent(s,"session_start")):setTimeout(measureEngagement,a-e)}function updateViewedVariants(e){return function wrapped(){null==e||e.filter((function(e){var n=e.coframe_id;return!u.includes(n)})).forEach((function(e){var n=e.coframe_id;document.querySelectorAll('[coframe-id="'.concat(n,'"]')).forEach((function(e){(function isElementVisible(e){var n=e.getBoundingClientRect();return n.top>=0&&n.bottom<=window.innerHeight})(e)&&(e.setAttribute("coframe-experienced","true"),u.push(n),sendEventToBackend({type:"view",coframe_page_id:window.COFRAME_PAGE_ID,session_id:s,coframe_id:n}))}))}))}}function unhideBody(){var e=document.getElementsByTagName("head")[0];if(e){var n=document.getElementById("coframe-body");n&&e.removeChild(n)}}function replaceVariants(e,n){if(e){o=new Date;var t=[];try{e.forEach((function(e){var r=e.original,o=e.copy,a=e.coframe_id,i=e.copy_id,c=e.xpath,u=e.selector,d=!1;u&&(d=function(e,n){var t=document.querySelector(e);return t?(t.textContent=n,!0):(console.error('css selector not found: "'.concat(e,'"')),!1)}(u,o),d)||c&&(d=function(e,n){var t=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return t?(t.textContent=n,!0):(console.error('xpath not found: "'.concat(e,'"')),!1)}(c,o),d)||(r&&0!==r.length?(d=replaceHTMLContent(r,o,a))||t.push({coframe_page_id:n,coframe_id:a,variant_id:i,session_id:s,type:"Original_Not_Found",time:new Date,description:window.location.href}):console.error("[Coframe] Original text is empty"))}))}catch(e){console.error("[Coframe]",e),t.push({coframe_page_id:n,variant_id:"",coframe_id:"",session_id:s,type:"Failed_To_Replace_Text",time:new Date,description:e.toString()})}setCoframeCookie(),function createSession(e,n,t,r,o){return session_awaiter(this,void 0,void 0,(function(){return session_generator(this,(function(a){switch(a.label){case 0:return[4,fetch("https://ingest.coframe.com/ingest/v1/session_result/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coframe_page_id:window.COFRAME_PAGE_ID,session_id:e,coframes:n,method:"scripts",metadata:{local_time:t,languages:void 0!==r?r.languages||r.language:[],platform:void 0!==r?r.platform||r.userAgentData&&r.userAgentData.platform:"",referrer:o,user_token:getCoframeUUID()}})})];case 1:return[2,a.sent().json()]}}))}))}(s,c,o,navigator,document.referrer),sendSessionEvent(s,"page_view"),setTimeout((function(){return measureEngagement()}),a);for(var r=0;r<t.length;r++)sendEventToBackend(t[r],"exceptions")}else setCoframeCookie()}var d={};d.init=function(){return src_awaiter(this,void 0,void 0,(function(){var e,n,t,r;return src_generator(this,(function(o){switch(o.label){case 0:return(e=window.COFRAME_PAGE_ID)?(function hideBody(){var e=document.getElementsByTagName("head")[0];if(e){var n=document.createElement("style");n.id="coframe-body",n.innerHTML="body {opacity: 0 !important}",e.appendChild(n)}setTimeout((function(){var e=document.getElementsByTagName("head")[0];if(e){var n=document.getElementById("coframe-body");n&&e.removeChild(n)}}),500)}(),new URLSearchParams(window.location.search).has("coframe_editor_id")?(n=function(){if(new URLSearchParams(window.location.search).has("coframe_editor_id")){var e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@coframe/coframe-editor/dist/ce.min.js",document.head.appendChild(e)}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n(),[3,3]):[3,1]):[2];case 1:return e?[4,getVariants(e)]:(sendEventToBackend({coframe_page_id:"",variant_id:"",coframe_id:"",type:"No_Coframe_Page_ID",time:new Date,session_id:"",description:window.location.href},"exceptions"),[2]);case 2:t=o.sent(),document.body?(replaceVariants(t,e),unhideBody()):document.addEventListener("DOMContentLoaded",(function(){replaceVariants(t,e),unhideBody()})),window.addEventListener("beforeunload",(function(){sendSessionEvent(s,"session_end")})),document.addEventListener("visibilitychange",measureEngagement),setTimeout(measureEngagement,a),document.addEventListener("coframe:dom-renderer:complete",updateViewedVariants(t)),document.addEventListener("scroll",updateViewedVariants(t)),document.dispatchEvent(new CustomEvent("coframe:dom-renderer:complete",{})),document.addEventListener("click",(function(e){return sendPageEngagementEvent("click",e,{isEngaged:i,sessionId:s})})),document.addEventListener("mouseover",(function(){r=Date.now()})),document.addEventListener("mouseout",(function(e){if(r){var n=Date.now()-r;n>=2e3&&sendPageEngagementEvent("hover",e,{isEngaged:i,sessionId:s,duration:n})}})),o.label=3;case 3:return[2]}}))}))},d.logCoframeConversion=function(e){sendEventToBackend({type:"conversion",coframe_page_id:window.COFRAME_PAGE_ID,session_id:s,label:e||""})},window.Coframe=d,d.init(),Coframejs=n})();