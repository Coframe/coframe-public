var Coframejs;(()=>{"use strict";var e={d:(n,t)=>{for(var r in t)e.o(t,r)&&!e.o(n,r)&&Object.defineProperty(n,r,{enumerable:!0,get:t[r]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};function replaceHTMLContent(e,n,t){var r=!1;if(containsHTML(e)||containsHTML(n))setTimeout((function(){var o=document.createElement("div");o.innerHTML=e;var i=document.createElement("div");i.innerHTML=n;for(var a,s=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT,null);(a=s.nextNode())&&a.innerHTML.includes(e);)r=!0;a.parentElement&&function replaceNodeContent(e,n,t,r){for(var o=document.createDocumentFragment(),i=0,a=Array.from(e.childNodes);i<a.length;i++){var s=a[i];if(s.nodeType===Node.ELEMENT_NODE&&s instanceof Element&&s.outerHTML.includes(n.innerHTML)){s.setAttribute("coframe-id",r);var c=s.outerHTML.replace(n.innerHTML,t.innerHTML),d=document.createElement("div");d.innerHTML=c,d.firstChild&&o.appendChild(d.firstChild)}else o.appendChild(s)}e.textContent="",e.appendChild(o)}(a.parentElement,o,i,t)}),0);else for(var o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null),i=new RegExp(e,"g"),a=void 0;a=o.nextNode();)a.parentElement&&"script"!==a.parentElement.tagName.toLowerCase()&&a.textContent&&a.textContent.search(i)>=0&&(a.textContent=a.textContent.replace(i,n),a.parentElement.setAttribute("coframe-id",t),r=!0);return r}function containsHTML(e){return/<[a-z][\s\S]*>/i.test(e)}e.r(n),e.d(n,{createSession:()=>createSession,getVariants:()=>getVariants,measureEngagement:()=>measureEngagement,sendEventToBackend:()=>sendEventToBackend,sendPageEngagementEvent:()=>sendPageEngagementEvent,sendSessionEvent:()=>sendSessionEvent});var t="coframe.user.token",getCookie=function(e){var n,t="; ".concat(document.cookie).split("; ".concat(e,"="));if(t.length>1)return null===(n=t.pop())||void 0===n?void 0:n.split(";").shift()},isCookieSet=function(e){return void 0!==getCookie(e)},setCookie=function(e,n){return document.cookie="".concat(e,"=").concat(n),isCookieSet(e)};const r={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let o;const i=new Uint8Array(16);function rng(){if(!o&&(o="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!o))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return o(i)}const a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));function unsafeStringify(e,n=0){return a[e[n+0]]+a[e[n+1]]+a[e[n+2]]+a[e[n+3]]+"-"+a[e[n+4]]+a[e[n+5]]+"-"+a[e[n+6]]+a[e[n+7]]+"-"+a[e[n+8]]+a[e[n+9]]+"-"+a[e[n+10]]+a[e[n+11]]+a[e[n+12]]+a[e[n+13]]+a[e[n+14]]+a[e[n+15]]}const s=function v4(e,n,t){if(r.randomUUID&&!n&&!e)return r.randomUUID();const o=(e=e||{}).random||(e.rng||rng)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,n){t=t||0;for(let e=0;e<16;++e)n[t+e]=o[e];return n}return unsafeStringify(o)};var c,d,__awaiter=function(e,n,t,r){return new(t||(t=Promise))((function(o,i){function fulfilled(e){try{step(r.next(e))}catch(e){i(e)}}function rejected(e){try{step(r.throw(e))}catch(e){i(e)}}function step(e){e.done?o(e.value):function adopt(e){return e instanceof t?e:new t((function(n){n(e)}))}(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())}))},__generator=function(e,n){var t,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function verb(s){return function(c){return function step(s){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(t=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=n.call(e,a)}catch(e){s=[6,e],r=0}finally{t=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},u=1e4,l=!1,f=[],m=[];function getVariants(e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(t){switch(t.label){case 0:return n="".concat("https://coframe.ai/api/v1","/retrieve_variants_page/"),[4,fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coframe_page_id:e,url:window.location.href})})];case 1:return[2,t.sent().json()]}}))}))}function createSession(e,n,r,o){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(i){switch(i.label){case 0:return"https://ingest.coframe.com/ingest/v1/session_result/",[4,fetch("https://ingest.coframe.com/ingest/v1/session_result/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coframe_page_id:window.COFRAME_PAGE_ID,session_id:e,coframes:f,method:"scripts",metadata:{local_time:n,languages:void 0!==r?r.languages||r.language:[],platform:void 0!==r?r.platform||r.userAgentData&&r.userAgentData.platform:"",referrer:o,user_token:getCookie(t)}})})];case 1:return[2,i.sent().json()]}}))}))}function sendEventToBackend(e,n){return void 0===n&&(n="events"),__awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t="https://ingest.coframe.com/ingest/v1/".concat(n,"/").concat(window.COFRAME_PAGE_ID,"/"),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})];case 2:return[2,r.sent().json()];case 3:return r.sent(),[3,4];case 4:return[2]}}))}))}function sendSessionEvent(e){sendEventToBackend({type:e,coframe_page_id:window.COFRAME_PAGE_ID,session_id:d})}function measureEngagement(){var e=(new Date).getTime()-(c?c.getTime():0);!l&&e>=u?(l=!0,sendSessionEvent("session_start")):setTimeout(measureEngagement,u-e)}function updateViewedVariants(e){return function wrapped(){null==e||e.filter((function(e){var n=e.coframe_id;return!m.includes(n)})).forEach((function(e){var n=e.coframe_id;document.querySelectorAll('[coframe-id="'.concat(n,'"]')).forEach((function(e){(function isElementVisible(e){var n=e.getBoundingClientRect();return n.top>=0&&n.bottom<=window.innerHeight})(e)&&(e.setAttribute("coframe-experienced","true"),m.push(n),sendEventToBackend({type:"view",coframe_page_id:window.COFRAME_PAGE_ID,session_id:d,coframe_id:n}))}))}))}}function sendPageEngagementEvent(e,n,t){var r;return void 0===t&&(t=0),__awaiter(this,void 0,void 0,(function(){function getXPath(e){for(var n="";e&&1==e.nodeType;e=e.parentNode)if(e.parentNode){var t=Array.prototype.indexOf.call(e.parentNode.childNodes,e)+1,r=t>1?"["+t.toString()+"]":"";n="/"+e.tagName.toLowerCase()+r+n}return n}var o,i,a,s,c;return __generator(this,(function(u){return l||"click"!==e||(l=!0,sendSessionEvent("session_start")),o=n.clientX+window.scrollX,i=n.clientY+window.scrollY,a=window.innerWidth,s=window.innerHeight,(c=null===(r=n.target)||void 0===r?void 0:r.closest("a, button, input, [onclick], [href]"))||(c=n.target),sendEventToBackend({type:e,coframe_page_id:window.COFRAME_PAGE_ID,session_id:d,content:{html:c.outerHTML,xpath:getXPath(c),position:{x:Math.round(o),y:Math.round(i)},screen_size:{width:a,height:s},"duration-ms":Math.round(t)}}),[2]}))}))}var p={init:function(){return __awaiter(this,void 0,void 0,(function(){var e,n,r,o,i,a,l;return __generator(this,(function(m){switch(m.label){case 0:return e=window.COFRAME_PAGE_ID,new URLSearchParams(window.location.search).has("coframe_editor_id")?(n=document.createElement("script"),(n=document.createElement("script")).src="https://cdn.jsdelivr.net/npm/@coframe/coframe-editor/dist/ce.min.js",document.head.appendChild(n),[3,3]):[3,1];case 1:return e?[4,getVariants(e)]:(sendEventToBackend({coframe_page_id:"",variant_id:"",coframe_id:"",type:"No_Coframe_Page_ID",time:new Date,session_id:"",description:window.location.href},"exceptions"),[2]);case 2:if(!(r=m.sent()).variants)return isCookieSet(t)||setCookie(t,s()),[2];o=r.variants,d=r.session_id,f=r.coframe_ids,c=new Date,i=[];try{o.forEach((function(n){var t=n.original,r=n.copy,o=n.coframe_id,a=n.copy_id;replaceHTMLContent(t,r,o)||i.push({coframe_page_id:e,coframe_id:o,variant_id:a,session_id:d,type:"Original_Not_Found",time:new Date})}))}catch(n){i.push({coframe_page_id:e,variant_id:"",coframe_id:"",session_id:d,type:"Failed_To_Replace_Text",time:new Date,description:n.toString()})}for(isCookieSet(t)||setCookie(t,s()),createSession(d,c,navigator,document.referrer),sendSessionEvent("page_view"),window.addEventListener("beforeunload",(function(){sendSessionEvent("session_end")})),document.addEventListener("visibilitychange",measureEngagement),setTimeout(measureEngagement,u),document.addEventListener("coframe:dom-renderer:complete",updateViewedVariants(o)),document.addEventListener("scroll",updateViewedVariants(o)),document.dispatchEvent(new CustomEvent("coframe:dom-renderer:complete",{})),document.addEventListener("click",(function(e){return sendPageEngagementEvent("click",e)})),document.addEventListener("mouseover",(function(){a=Date.now()})),document.addEventListener("mouseout",(function(e){if(a){var n=Date.now()-a;n>=2e3&&sendPageEngagementEvent("hover",e,n)}})),setTimeout((function(){return measureEngagement()}),u),l=0;l<i.length;l++)sendEventToBackend(i[l],"exceptions");m.label=3;case 3:return[2]}}))}))},logCoframeConversion:function(e){sendEventToBackend({type:"conversion",coframe_page_id:window.COFRAME_PAGE_ID,session_id:d,label:e||""})}};window.Coframe=p,p.init(),Coframejs=n})();