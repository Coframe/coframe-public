var Coframejs;(()=>{"use strict";var e={d:(n,t)=>{for(var r in t)e.o(t,r)&&!e.o(n,r)&&Object.defineProperty(n,r,{enumerable:!0,get:t[r]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};function replaceHTMLContent(e,n,t){if(containsHTML(e)||containsHTML(n))setTimeout((function(){var r=document.createElement("div");r.innerHTML=e;var o=document.createElement("div");o.innerHTML=n;for(var i,a=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT,null);(i=a.nextNode())&&i.innerHTML.includes(e););i.parentElement&&function replaceNodeContent(e,n,t,r){for(var o=document.createDocumentFragment(),i=0,a=Array.from(e.childNodes);i<a.length;i++){var s=a[i];if(s.nodeType===Node.ELEMENT_NODE&&s instanceof Element&&s.outerHTML.includes(n.innerHTML)){s.setAttribute("coframe-id",r);var c=s.outerHTML.replace(n.innerHTML,t.innerHTML),d=document.createElement("div");d.innerHTML=c,d.firstChild&&o.appendChild(d.firstChild)}else o.appendChild(s)}e.textContent="",e.appendChild(o)}(i.parentElement,r,o,t)}),0);else for(var r=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null),o=new RegExp(e,"g"),i=void 0;i=r.nextNode();)i.parentElement&&"script"!==i.parentElement.tagName.toLowerCase()&&i.textContent&&i.textContent.search(o)>=0&&(i.textContent=i.textContent.replace(o,n),i.parentElement.setAttribute("coframe-id",t))}function containsHTML(e){return/<[a-z][\s\S]*>/i.test(e)}e.r(n),e.d(n,{createSession:()=>createSession,getVariants:()=>getVariants,measureEngagement:()=>measureEngagement,sendEventToBackend:()=>sendEventToBackend,sendPageEngagementEvent:()=>sendPageEngagementEvent,sendSessionEvent:()=>sendSessionEvent});var __awaiter=function(e,n,t,r){return new(t||(t=Promise))((function(o,i){function fulfilled(e){try{step(r.next(e))}catch(e){i(e)}}function rejected(e){try{step(r.throw(e))}catch(e){i(e)}}function step(e){e.done?o(e.value):function adopt(e){return e instanceof t?e:new t((function(n){n(e)}))}(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())}))},__generator=function(e,n){var t,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function verb(s){return function(c){return function step(s){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(t=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=n.call(e,a)}catch(e){s=[6,e],r=0}finally{t=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},t=1e4,r=null,o=!1,i=null,a=[],s=window.COFRAME_PAGE_ID,c=[];function getVariants(e,n,t,r){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(t){switch(t.label){case 0:return n="".concat("https://coframe.ai/api/v1","/retrieve_variants_page/"),[4,fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coframe_page_id:e})})];case 1:return[2,t.sent().json()]}}))}))}function createSession(e,n,t,r){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(o){switch(o.label){case 0:return"https://ingest.coframe.com/ingest/v1/session_result/",console.log(a),[4,fetch("https://ingest.coframe.com/ingest/v1/session_result/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coframe_page_id:window.COFRAME_PAGE_ID,session_id:e,coframes:a,script:"scripts",metadata:{local_time:n,languages:void 0!==t?t.languages||t.language:[],platform:void 0!==t?t.platform||t.userAgentData&&t.userAgentData.platform:"",referrer:r}})})];case 1:return[2,o.sent().json()]}}))}))}function sendEventToBackend(e){return __awaiter(this,void 0,void 0,(function(){var n,t;return __generator(this,(function(r){switch(r.label){case 0:n="https://ingest.coframe.com/ingest/v1/events/".concat(window.COFRAME_PAGE_ID,"/"),r.label=1;case 1:return r.trys.push([1,3,,4]),console.log(e),[4,fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})];case 2:return[2,r.sent().json()];case 3:return t=r.sent(),console.error("Failed to send data:",t),[3,4];case 4:return[2]}}))}))}function sendSessionEvent(e){sendEventToBackend({type:e,coframe_page_id:window.COFRAME_PAGE_ID,session_id:i})}function measureEngagement(){var e=new Date-r;!o&&e>=t?(o=!0,sendSessionEvent("session_start")):setTimeout(measureEngagement,t-e)}function updateViewedVariants(e){return function wrapped(n){null==e||e.filter((function(e){var n=e.coframe_id;return!c.includes(n)})).forEach((function(e){var n=e.coframe_id;document.querySelectorAll('[coframe-id="'.concat(n,'"]')).forEach((function(e){(function isElementVisible(e){var n=e.getBoundingClientRect();return n.top>=0&&n.bottom<=window.innerHeight})(e)&&(e.setAttribute("coframe-experienced","true"),c.push(n),sendEventToBackend({type:"view",coframe_page_id:window.COFRAME_PAGE_ID,session_id:i,coframe_id:n}))}))}))}}function sendPageEngagementEvent(e,n,t){return void 0===t&&(t=0),__awaiter(this,void 0,void 0,(function(){function getXPath(e){for(var n="";e&&1==e.nodeType;e=e.parentNode){var t=Array.prototype.indexOf.call(e.parentNode.childNodes,e)+1;t=t>1?"["+t+"]":"",n="/"+e.tagName.toLowerCase()+t+n}return n}var r,a,c,d,u;return __generator(this,(function(l){return o||(o=!0,sendSessionEvent("session_start")),r=n.clientX+window.scrollX,a=n.clientY+window.scrollY,c=window.innerWidth,d=window.innerHeight,(u=n.target.closest("a, button, input, [onclick], [href]"))||(u=n.target),sendEventToBackend({type:e,coframe_page_id:s,session_id:i,content:{html:u.outerHTML,xpath:getXPath(u),position:{x:Math.round(r),y:Math.round(a)},screen_size:{width:c,height:d},"duration-ms":Math.round(t)}}),[2]}))}))}var d={init:function(){return __awaiter(this,void 0,void 0,(function(){var e,n,o,s,c;return __generator(this,(function(d){switch(d.label){case 0:return e=window.COFRAME_PAGE_ID,new URLSearchParams(window.location.search).has("coframe_editor_id")&&document.referrer&&"coframe.ai"===new URL(document.referrer).hostname?(n=document.createElement("script"),(n=document.createElement("script")).src="https://cdn.jsdelivr.net/npm/@coframe/coframe-editor@1.0.5/dist/ce.min.js",document.head.appendChild(n),[3,3]):[3,1];case 1:return[4,getVariants(e,0,navigator,document.referrer)];case 2:o=d.sent(),s=o.variants,i=o.session_id,a=o.coframe_ids,r=new Date,createSession(i,r,navigator,document.referrer),window.addEventListener("beforeunload",(function(){sendSessionEvent("session_end")})),document.addEventListener("visibilitychange",console.log("visibility"),measureEngagement),setTimeout(measureEngagement,t),document.addEventListener("coframe:dom-renderer:complete",updateViewedVariants(s)),document.addEventListener("scroll",updateViewedVariants(s));try{s.forEach((function(e){replaceHTMLContent(e.original,e.copy,e.coframe_id)}))}catch(e){}document.dispatchEvent(new CustomEvent("coframe:dom-renderer:complete",{})),document.addEventListener("click",(function(e){return sendPageEngagementEvent("click",e)})),c=null,document.addEventListener("mouseover",(function(){c=Date.now()})),document.addEventListener("mouseout",(function(e){if(c){var n=Date.now()-c;n>=2e3&&sendPageEngagementEvent("hover",e,n)}})),setTimeout((function(){return measureEngagement()}),t),d.label=3;case 3:return[2]}}))}))},logCoframeConversion:function(){console.log("Coframe conversion"),sendEventToBackend({type:"conversion",coframe_page_id:window.COFRAME_PAGE_ID,session_id:i})}};window.Coframe=d,d.init(),Coframejs=n})();